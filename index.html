<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quản lý chi tiêu</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; background:#f4f4f4; margin:0; padding:20px; }
  .container { max-width:650px; margin:auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.1);}
  h1 { text-align:center; margin-bottom:20px; }
  input, select, button { width:100%; padding:10px; margin-top:10px; border:1px solid #ccc; border-radius:6px; }
  button { background:#009688; color:white; border:none; font-weight:bold; cursor:pointer; }
  button:hover { background:#00796B; }
  ul { list-style-type:none; padding:0; }
  li { background:#eee; padding:10px; margin-top:5px; border-radius:6px; display:flex; justify-content:space-between; align-items:center; }
  .summary { margin-top:20px; padding:10px; background:#fafafa; border-radius:6px; }
  .hidden { display:none; }
  .chart-container { margin:20px 0; }
  .delete-btn { background:none; border:none; color:red; font-weight:bold; cursor:pointer; }
</style>
</head>
<body>
<div class="container">
  <h1>Quản lý chi tiêu</h1>

  <!-- Form nhập -->
  <select id="type" onchange="toggleCategory()">
    <option value="income">Thu nhập</option>
    <option value="expense">Chi tiêu</option>
  </select>

  <select id="expenseCategory" style="display:none;">
    <option value="Đầu tư trí tuệ">Đầu tư trí tuệ</option>
    <option value="Cà phê">Cà phê</option>
    <option value="Mua sắm">Mua sắm</option>
    <option value="Thức ăn">Thức ăn</option>
    <option value="Đầu tư tài chính">Đầu tư tài chính</option>
    <option value="Nợ ngân hàng">Nợ ngân hàng</option>
    <option value="Bảo hiểm">Bảo hiểm</option>
  </select>

  <input type="number" id="amount" placeholder="Số tiền">
  <input type="text" id="note" placeholder="Ghi chú">
  <button onclick="addTransaction()">Thêm giao dịch</button>

  <!-- Bộ lọc -->
  <h3>Lọc giao dịch</h3>
  <input type="month" id="filterMonth" onchange="updateUI()">
  <input type="date" id="filterDate" onchange="updateUI()">
  <button onclick="clearFilters()">Xóa bộ lọc</button>

  <!-- Tổng kết -->
  <div class="summary">
    <p><strong>Tổng thu:</strong> <span id="totalIncome">0</span></p>
    <p><strong>Tổng chi:</strong> <span id="totalExpense">0</span></p>
    <p><strong>Số dư:</strong> <span id="balance">0</span></p>
  </div>

  <!-- Biểu đồ nhỏ tổng hợp chi theo danh mục -->
  <div class="chart-container">
    <h3>Chi theo danh mục</h3>
    <canvas id="miniBarChart"></canvas>
  </div>

  <!-- Biểu đồ pie -->
  <div class="chart-container">
    <h3>Biểu đồ Pie</h3>
    <canvas id="expenseChart"></canvas>
  </div>

  <!-- Danh sách chi tiết khi click -->
  <div id="detailsSection" class="hidden">
    <h3>Chi tiết giao dịch</h3>
    <ul id="transactionList"></ul>
  </div>
</div>

<script>
let transactions = JSON.parse(localStorage.getItem("transactions")) || [];
let pieChart, barChart;
let currentCategory = null; // lưu mục đang xem chi tiết

// Hiện/ẩn danh mục chi tiêu
function toggleCategory() {
  const type = document.getElementById("type").value;
  document.getElementById("expenseCategory").style.display = (type === "expense") ? "block" : "none";
}

// Thêm giao dịch
function addTransaction() {
  const note = document.getElementById("note").value;
  const amount = parseFloat(document.getElementById("amount").value);
  const type = document.getElementById("type").value;
  const category = (type === "expense") ? document.getElementById("expenseCategory").value : "";

  if (isNaN(amount) || amount <= 0) {
    alert("Vui lòng nhập số tiền hợp lệ!");
    return;
  }

  const now = new Date();
  const date = now.toISOString().split("T")[0];
  const time = now.toLocaleTimeString("vi-VN");

  transactions.push({ note, amount, type, category, date, time });
  localStorage.setItem("transactions", JSON.stringify(transactions));
  updateUI();

  document.getElementById("note").value = "";
  document.getElementById("amount").value = "";
}

// Cập nhật giao diện
function updateUI() {
  let totalIncome = 0;
  let totalExpense = 0;
  let categoryTotals = {
    "Đầu tư trí tuệ": 0,
    "Cà phê": 0,
    "Mua sắm": 0,
    "Thức ăn": 0,
    "Đầu tư tài chính": 0,
    "Nợ ngân hàng": 0,
    "Bảo hiểm": 0
  };

  const filterMonth = document.getElementById("filterMonth").value;
  const filterDate = document.getElementById("filterDate").value;

  transactions.forEach((t) => {
    let show = true;
    if (filterMonth && !t.date.startsWith(filterMonth)) show = false;
    if (filterDate && t.date !== filterDate) show = false;

    if (show) {
      if (t.type === "income") totalIncome += t.amount;
      else {
        totalExpense += t.amount;
        if (categoryTotals[t.category] !== undefined) {
          categoryTotals[t.category] += t.amount;
        }
      }
    }
  });

  document.getElementById("totalIncome").textContent = totalIncome.toLocaleString();
  document.getElementById("totalExpense").textContent = totalExpense.toLocaleString();
  document.getElementById("balance").textContent = (totalIncome - totalExpense).toLocaleString();

  renderBarChart(categoryTotals);
  renderPieChart(categoryTotals);

  if (currentCategory) {
    showDetails(currentCategory); // cập nhật chi tiết nếu đang mở
  }
}

// Vẽ biểu đồ cột nhỏ
function renderBarChart(data) {
  const ctx = document.getElementById("miniBarChart").getContext("2d");
  if (barChart) barChart.destroy();
  barChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: Object.keys(data),
      datasets: [{
        label: "Chi tiêu",
        data: Object.values(data),
        backgroundColor: "#009688"
      }]
    },
    options: { 
      responsive: true, 
      plugins: { legend: { display: false } },
      onClick: (e, elements) => {
        if (elements.length > 0) {
          const index = elements[0].index;
          const category = barChart.data.labels[index];
          showDetails(category);
        }
      }
    }
  });
}

// Vẽ biểu đồ Pie
function renderPieChart(data) {
  const ctx = document.getElementById("expenseChart").getContext("2d");
  if (pieChart) pieChart.destroy();
  pieChart = new Chart(ctx, {
    type: "pie",
    data: {
      labels: Object.keys(data),
      datasets: [{
        data: Object.values(data),
        backgroundColor: ["#4caf50","#ff9800","#2196f3","#e91e63","#9c27b0","#795548","#00bcd4"]
      }]
    },
    options: {
      onClick: (e, elements) => {
        if (elements.length > 0) {
          const index = elements[0].index;
          const category = pieChart.data.labels[index];
          showDetails(category);
        }
      },
      plugins: { legend: { position: "bottom" } }
    }
  });
}

// Hiển thị chi tiết khi click vào biểu đồ
function showDetails(category) {
  currentCategory = category;
  const details = document.getElementById("transactionList");
  const section = document.getElementById("detailsSection");
  details.innerHTML = "";

  transactions.forEach((t, idx) => {
    if (t.type === "expense" && t.category === category) {
      const li = document.createElement("li");
      li.innerHTML = `${t.date} ${t.time} - ${t.note} - ${t.amount.toLocaleString()}₫
        <button class="delete-btn" onclick="removeTransaction(${idx})">X</button>`;
      details.appendChild(li);
    }
  });

  section.classList.remove("hidden");
}

// Xóa giao dịch
function removeTransaction(index) {
  transactions.splice(index, 1);
  localStorage.setItem("transactions", JSON.stringify(transactions));
  updateUI();
}

// Xóa bộ lọc
function clearFilters() {
  document.getElementById("filterMonth").value = "";
  document.getElementById("filterDate").value = "";
  updateUI();
}

updateUI();
</script>
</body>
</html>
